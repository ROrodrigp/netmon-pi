# =============================================================================
# WORKFLOW: Validar datos del escaneo
# =============================================================================
# Este workflow se ejecuta cada vez que la Raspberry Pi hace push de un nuevo
# escaneo. Valida que el JSON tenga la estructura correcta y muestra un resumen.
# =============================================================================

name: Validate Scan Data

# -----------------------------------------------------------------------------
# ON: ¿Cuándo se ejecuta este workflow?
# -----------------------------------------------------------------------------
# "push" = cuando alguien hace push al repositorio
# "paths" = SOLO si los archivos modificados coinciden con este patrón
#
# Esto significa: "Ejecuta este workflow cuando haya un push que modifique
# cualquier archivo dentro de la carpeta data/"
# -----------------------------------------------------------------------------
on:
  push:
    paths:
      - 'data/**'

# -----------------------------------------------------------------------------
# JOBS: ¿Qué trabajos ejecutar?
# -----------------------------------------------------------------------------
# Cada job corre en una máquina virtual independiente.
# Aquí solo tenemos un job llamado "validate".
# -----------------------------------------------------------------------------
jobs:
  validate:
    name: Validate JSON Structure

    # La VM donde correrá (Ubuntu Linux gratuito de GitHub)
    runs-on: ubuntu-latest

    # -------------------------------------------------------------------------
    # STEPS: Pasos secuenciales del job
    # -------------------------------------------------------------------------
    steps:
      # Paso 1: Descargar el código del repositorio a la VM
      - name: Checkout repository
        uses: actions/checkout@v4

      # Paso 2: Instalar Python (la VM tiene Python, pero esto garantiza la versión)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # Paso 3: Validar el JSON y mostrar resumen
      # Usamos Python inline (sin archivo separado) para mantenerlo simple
      - name: Validate and summarize scan results
        run: |
          python << 'EOF'
          import json
          import sys
          from datetime import datetime

          # Leer el archivo JSON
          try:
              with open('data/scan_results.json', 'r') as f:
                  data = json.load(f)
          except FileNotFoundError:
              print("ERROR: scan_results.json not found")
              sys.exit(1)
          except json.JSONDecodeError as e:
              print(f"ERROR: Invalid JSON - {e}")
              sys.exit(1)

          # Validar campos requeridos
          required_fields = ['scan_timestamp', 'host', 'interface', 'devices_count', 'devices']
          missing = [f for f in required_fields if f not in data]

          if missing:
              print(f"ERROR: Missing required fields: {missing}")
              sys.exit(1)

          # Validar que devices sea una lista
          if not isinstance(data['devices'], list):
              print("ERROR: 'devices' must be a list")
              sys.exit(1)

          # Validar estructura de cada dispositivo
          for i, device in enumerate(data['devices']):
              for field in ['ip', 'mac', 'vendor']:
                  if field not in device:
                      print(f"ERROR: Device {i} missing field '{field}'")
                      sys.exit(1)

          # Todo válido - mostrar resumen
          print("=" * 60)
          print("SCAN RESULTS VALIDATED SUCCESSFULLY")
          print("=" * 60)
          print(f"Timestamp:    {data['scan_timestamp']}")
          print(f"Host:         {data['host']}")
          print(f"Interface:    {data['interface']}")
          print(f"Device count: {data['devices_count']}")
          print("-" * 60)
          print("Devices:")
          for device in data['devices']:
              print(f"  {device['ip']:15} {device['mac']}  {device['vendor']}")
          print("=" * 60)
          EOF
